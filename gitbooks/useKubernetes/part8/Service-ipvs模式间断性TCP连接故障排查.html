
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>8.2. Service ipvs模式间断性TCP连接故障排查 · Kubernetes生态圈使用</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="ywq">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="kubeadm证书-etcd证书过期紧急处理.html" />
    
    
    <link rel="prev" href="Kubernetes部署问题记录.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Part 1-写在前面</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    1. 总览篇
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 2-集群相关</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../part2/">
            
                <a href="../part2/">
            
                    
                    2. 集群相关
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../part2/v1.9.0高可用集群本地离线部署记录.html">
            
                <a href="../part2/v1.9.0高可用集群本地离线部署记录.html">
            
                    
                    2.1. v1.9.0高可用集群部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../part2/v1.14多master集群部署.html">
            
                <a href="../part2/v1.14多master集群部署.html">
            
                    
                    2.2. v1.14.3高可用集群部署
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../part2/Kubernetes中的Pause容器.html">
            
                <a href="../part2/Kubernetes中的Pause容器.html">
            
                    
                    2.3. Kubernetes中的Pause容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="../part2/RBAC权限控制.html">
            
                <a href="../part2/RBAC权限控制.html">
            
                    
                    2.4. RBAC权限控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="../part2/docker-k8s常用命令速查及rest-api.html">
            
                <a href="../part2/docker-k8s常用命令速查及rest-api.html">
            
                    
                    2.5. 常用命令与rest-api速查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="../part2/Kubernetes各组件参数配置优化建议.html">
            
                <a href="../part2/Kubernetes各组件参数配置优化建议.html">
            
                    
                    2.6. Kubernetes各组件参数配置优化建议
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 3-网络与服务</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../part3/">
            
                <a href="../part3/">
            
                    
                    3. 网络与服务
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../part3/Traefik提供ingress-http服务.html">
            
                <a href="../part3/Traefik提供ingress-http服务.html">
            
                    
                    3.1. Traefik 提供ingress http服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../part3/kube-router提供BGP全直通网络.html">
            
                <a href="../part3/kube-router提供BGP全直通网络.html">
            
                    
                    3.2. Kube-router BGP全直通网络
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../part3/kube-router工作模式抓包分析.html">
            
                <a href="../part3/kube-router工作模式抓包分析.html">
            
                    
                    3.3. Kube-router ipvs Service模式抓包分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../part3/VXLAN和Flannel.html">
            
                <a href="../part3/VXLAN和Flannel.html">
            
                    
                    3.4. VXLAN和Flannel
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 4-监控</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../part4/">
            
                <a href="../part4/">
            
                    
                    4. Prometheus监控
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../part4/监控--Prometheus部署篇.html">
            
                <a href="../part4/监控--Prometheus部署篇.html">
            
                    
                    4.1. Prometheus部署篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../part4/监控--Prometheus扩展篇（mysqld-exporter、服务发现、监控项、联邦、relabel）.html">
            
                <a href="../part4/监控--Prometheus扩展篇（mysqld-exporter、服务发现、监控项、联邦、relabel）.html">
            
                    
                    4.2. Prometheus扩展篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../part4/监控--Prometheus告警篇（告警消息对接钉钉接口）.html">
            
                <a href="../part4/监控--Prometheus告警篇（告警消息对接钉钉接口）.html">
            
                    
                    4.3. Prometheus告警篇
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 5-分布式存储Ceph</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../part5/">
            
                <a href="../part5/">
            
                    
                    5. Ceph存储
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../part5/Ceph集群生产环境安装部署.html">
            
                <a href="../part5/Ceph集群生产环境安装部署.html">
            
                    
                    5.1. Ceph部署篇
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../part5/cephfs调优-性能测试-监控-常用命令.html">
            
                <a href="../part5/cephfs调优-性能测试-监控-常用命令.html">
            
                    
                    5.2. Ceph性能调优
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../part5/分布式存储Cephfs使用.html">
            
                <a href="../part5/分布式存储Cephfs使用.html">
            
                    
                    5.3. Cephfs在k8s中使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="../part5/分布式存储Ceph-RBD使用.html">
            
                <a href="../part5/分布式存储Ceph-RBD使用.html">
            
                    
                    5.4. Ceph RBD在k8s中使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.5" data-path="../part5/Cephfs-CephRBD在k8s中的适用场景讨论及数据库性能压测.html">
            
                <a href="../part5/Cephfs-CephRBD在k8s中的适用场景讨论及数据库性能压测.html">
            
                    
                    5.5. Ceph在k8s中的综合场景应用及数据库OLTP性能压测
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 6-微服务框架Istio</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../part6/">
            
                <a href="../part6/">
            
                    
                    6. Istio微服务框架
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../part6/微服务框架istio安装测试.html">
            
                <a href="../part6/微服务框架istio安装测试.html">
            
                    
                    6.1. istio安装测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../part6/微服务框架istio流量策略控制.html">
            
                <a href="../part6/微服务框架istio流量策略控制.html">
            
                    
                    6.2. istio流量策略控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../part6/微服务框架istio服务可视化与监控.html">
            
                <a href="../part6/微服务框架istio服务可视化与监控.html">
            
                    
                    6.3. istio服务可视化与监控
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../part6/微服务--istio1.0抢鲜测试.html">
            
                <a href="../part6/微服务--istio1.0抢鲜测试.html">
            
                    
                    6.4. istio v1.0 抢鲜测试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 7-周边生态</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../part7/">
            
                <a href="../part7/">
            
                    
                    7. 周边生态
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1.1" data-path="../part7/Docker-registry仓库历史镜像批量清理.html">
            
                <a href="../part7/Docker-registry仓库历史镜像批量清理.html">
            
                    
                    7.1. Docker-registry历史镜像批量清理.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.2" data-path="../part7/企业级docker仓库Harbor在kubernetes上搭建使用.html">
            
                <a href="../part7/企业级docker仓库Harbor在kubernetes上搭建使用.html">
            
                    
                    7.2. Harbor部署使用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 8-问题记录</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="./">
            
                <a href="./">
            
                    
                    8. 问题记录
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1.1" data-path="Kubernetes部署问题记录.html">
            
                <a href="Kubernetes部署问题记录.html">
            
                    
                    8.1. 集群部署问题记录
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="8.1.2" data-path="Service-ipvs模式间断性TCP连接故障排查.html">
            
                <a href="Service-ipvs模式间断性TCP连接故障排查.html">
            
                    
                    8.2. Service ipvs模式间断性TCP连接故障排查
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.1.3" data-path="kubeadm证书-etcd证书过期紧急处理.html">
            
                <a href="kubeadm证书-etcd证书过期紧急处理.html">
            
                    
                    8.3. kubeadm证书-etcd证书过期紧急处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.1.4" data-path="Kubernetes-Pod无法终结问题排查.html">
            
                <a href="Kubernetes-Pod无法终结问题排查.html">
            
                    
                    8.4. Kubernetes-Pod无法终结问题排查
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >8.2. Service ipvs模式间断性TCP连接故障排查</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E00;"><a name="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E00;" class="plugin-anchor" href="#&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E00;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x95EE;&#x9898;&#x9636;&#x6BB5;(&#x4E00;):</h2>
<p>&#x7528;&#x6237;&#x53CD;&#x5E94;&#x67D0;&#x4E2A;redis&#x4F7F;&#x7528;&#x5361;&#x987F;&#xFF0C;&#x8FDE;&#x63A5;&#x8BE5;redis&#x670D;&#x52A1;&#x4F7F;&#x7528;&#x7684;&#x662F;svc&#x4EE3;&#x7406;&#xFF0C;&#x5373;ipvs snat&#x7684;&#x65B9;&#x5F0F;&#xFF0C;ipvsadm -L&#x53D1;&#x73B0;&#xFF0C;VIP&#x6536;&#x5230;&#x7684;6379&#x7AEF;&#x53E3;&#x7684;&#x6570;&#x636E;&#x5305;&#xFF0C;&#x4F1A;&#x4EE5;rr&#x7684;&#x65B9;&#x5F0F;&#x5206;&#x522B;&#x8F6C;&#x53D1;&#x5230;pod&#x7684;80 6379&#x7AEF;&#x53E3;&#x4E0A;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4F1A;&#x6709;50%&#x7684;&#x4E22;&#x5305;&#xFF0C;&#x4E0D;&#x5361;&#x624D;&#x602A;&#xFF1A;</p>
<pre><code># ipvsadm | grep -2 10.108.152.210
TCP  10.108.152.210:6379 rr
  -&gt; 172.26.6.185:http            Masq    1      0          0         
  -&gt; 172.26.6.185:6379            Masq    1      3          3
</code></pre><p>2.&#x68C0;&#x67E5;svc&#xFF1A;</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  creationTimestamp: 2018-12-06T02:45:49Z
  labels:
    app: skuapi-rds-prod
    run: skuapi-rds-prod
  name: skuapi-rds-prod
  namespace: default
  resourceVersion: &quot;41888273&quot;
  selfLink: /api/v1/namespaces/default/services/skuapi-rds-prod
  uid: 09e1a61f-f901-11e8-878f-141877468256
spec:
  clusterIP: 10.108.152.210
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379
  selector:
    app: skuapi-rds-prod
  sessionAffinity: None
  type: ClusterIP
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;svc&#x914D;&#x7F6E;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x56DE;&#x5FC6;&#x8D77;&#x6B64;&#x524D;&#x914D;&#x7F6E;&#x6B64;svc&#x65F6;&#xFF0C;&#x4E00;&#x5F00;&#x59CB;&#x5931;&#x8BEF;&#x5C06;port&#x548C;targetPort&#x8BBE;&#x7F6E;&#x4E3A;&#x4E86;&#x9ED8;&#x8BA4;&#x503C;80&#x5FD8;&#x8BB0;&#x4FEE;&#x6539;&#x4E86;&#xFF0C;&#x540E;&#x9762;&#x624B;&#x52A8;kubectl edit svc&#x4FEE;&#x6539;&#x7AEF;&#x53E3;&#x4E3A;6379&#x3002;&#x5E94;&#x8BE5;&#x662F;&#x4FEE;&#x6539;&#x4FDD;&#x5B58;&#x4E4B;&#x540E;&#xFF0C;&#x539F;&#x672C;&#x7684;targetPort 80
&#x4F9D;&#x7136;&#x5728;ipvs&#x4E2D;&#x4FDD;&#x7559;&#x4E3A;RIP&#x4E4B;&#x4E00;&#xFF0C;&#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x4E00;&#x4E2A;bug&#x3002;</p>
<p>3.&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;
&#x4F7F;&#x7528;ipvsadm&#x5DE5;&#x5177;&#x5220;&#x9664;&#x591A;&#x4F59;&#x7684;RIP&#xFF0C;&#x6216;&#x8005;&#x5220;&#x9664;&#x6B64;svc&#x7136;&#x540E;&#x91CD;&#x5EFA;&#x3002;</p>
<pre><code># ipvsadm | grep -2 10.108.152.210
TCP  10.108.152.210:6379 rr
  -&gt; 172.26.6.185:6379            Masq    1      4          0
</code></pre><h2 id="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E8C;"><a name="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E8C;" class="plugin-anchor" href="#&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E8C;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x95EE;&#x9898;&#x9636;&#x6BB5;(&#x4E8C;):</h2>
<h5 id="&#x73B0;&#x8C61;&#xFF1A;"><a name="&#x73B0;&#x8C61;&#xFF1A;" class="plugin-anchor" href="#&#x73B0;&#x8C61;&#xFF1A;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x73B0;&#x8C61;&#xFF1A;</h5>
<p>&#x6709;&#x7528;&#x6237;&#x53CD;&#x9988;svc vip&#x8FDE;&#x63A5;&#x7ECF;&#x5E38;&#x5931;&#x8D25;&#xFF0C;&#x4E0D;&#x9650;&#x4E8E;redis&#x7684;&#x591A;&#x4E2A;ip&#x6709;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x4E8E;&#x662F;&#x5F00;&#x59CB;&#x6392;&#x67E5;</p>
<h5 id="&#x6392;&#x67E5;"><a name="&#x6392;&#x67E5;" class="plugin-anchor" href="#&#x6392;&#x67E5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6392;&#x67E5;:</h5>
<p>&#x901A;&#x8FC7;&#x5BF9;ipvs&#x548C;&#x7CFB;&#x7EDF;&#x7684;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x6392;&#x67E5;&#xFF0C;&#x53D1;&#x73B0;&#x4E86;&#x4E24;&#x4E2A;&#x95EE;&#x9898;:
1.&#x53D1;&#x73B0;&#x6709;&#x5927;&#x91CF;TIME_WAIT&#x7684;tcp&#x8FDE;&#x63A5;,&#x8BC1;&#x660E;&#x7CFB;&#x7EDF;&#x8FDE;&#x63A5;&#x5927;&#x591A;&#x662F;&#x77ED;&#x8FDE;&#x63A5;&#xFF0C;&#x67E5;&#x770B;ipvs tcpfin&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x4E3A;2&#x5206;&#x949F;&#xFF0C;&#x4E24;&#x5206;&#x949F;&#x8FD8;&#x662F;&#x8FC7;&#x957F;&#xFF0C;&#x6709;&#x5FC5;&#x8981;&#x4FEE;&#x6539;&#x77ED;&#x4E00;&#x4E9B;&#xFF0C;30&#x79D2;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5408;&#x7406;&#x7684;&#x503C;&#xFF0C;&#x5982;&#x679C;&#x6BD4;&#x8F83;&#x7E41;&#x5FD9;&#x7684;&#x670D;&#x52A1;&#xFF0C;&#x8FD9;&#x4E2A;&#x503C;&#x53EF;&#x4EE5;&#x6539;&#x5230;&#x66F4;&#x4F4E;&#x3002;
2.&#x6709;&#x4E0D;&#x5C11;&#x4E22;&#x5305;</p>
<pre><code>[root@p020107 ~]# ipvsadm -lnc |wc -l
23776
[root@p020107 ~]# ipvsadm -lnc |grep TIME_WAIT | wc -l
10003
[root@p020107 ~]# ipvsadm -L --timeout 
Timeout (tcp tcpfin udp): 900 120 300

root@p020107:~# netstat -s | grep timestamp
    17855 packets rejects in established connections because of timestamp
</code></pre><p>&#x5907;&#x6CE8;&#xFF1A;
&#x6839;&#x636E;tcp &#x56DB;&#x6B21;&#x6325;&#x624B;&#x534F;&#x8BAE;&#xFF0C;&#x4E3B;&#x52A8;&#x53D1;&#x8D77;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x7684;&#x7684;&#x4E00;&#x7AEF;(&#x7B80;&#x5355;&#x7406;&#x89E3;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;)&#xFF0C;&#x5728;&#x5176;&#x53D1;&#x9001;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x5F00;&#x59CB;&#xFF0C;&#x5176;&#x8FDE;&#x63A5;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x4F1A;&#x7ECF;&#x5386;4&#x4E2A;&#x9636;&#x6BB5;&#x5206;&#x522B;&#x662F;FIN-WAIT1 --&gt; FIN_WAIT2 --&gt; TIME_WAIT --&gt; CLOSE&#xFF0C;&#x5176;&#x4E2D;2&#x4E2A;FIN-WAIT&#x9636;&#x6BB5;&#x7B49;&#x5F85;&#x7684;&#x65F6;&#x95F4;&#x5C31;&#x662F;&#x5185;&#x6838;&#x914D;&#x7F6E;&#x7684;net.ipv4.tcp_fin_timeout &#x7684;&#x503C;&#xFF0C;&#x4E3A;&#x4E86;&#x5FEB;&#x901F;&#x8DF3;&#x8FC7;&#x524D;&#x4E24;&#x4E2A;FIN-WAIT&#x9636;&#x6BB5;&#x4ECE;&#x800C;&#x8FDB;&#x5165;TIME_WAIT&#x72B6;&#x6001;&#xFF0C;net.ipv4.tcp_fin_timeout&#x503C;&#x5EFA;&#x8BAE;&#x7F29;&#x77ED;&#x3002;&#x5728;&#x8FDB;&#x5165;TIME_WAIT&#x72B6;&#x6001;&#x540E;&#xFF0C;&#x9ED8;&#x8BA4;&#x7B49;&#x5F85;2&#x4E2A;MSL(Max Segment Lifetime)&#x65F6;&#x95F4;&#xFF0C;&#x5230;&#x8FBE;&#x6700;&#x540E;&#x4E00;&#x6B65;CLOSE&#x72B6;&#x6001;&#xFF0C;&#x5173;&#x95ED;tcp&#x8FDE;&#x63A5;&#x91CA;&#x653E;&#x8D44;&#x6E90;&#x3002;&#x6CE8;&#x610F;&#xFF1A;MSL&#x65F6;&#x95F4;&#x5728;&#x4E0D;&#x540C;&#x5E73;&#x53F0;&#x4E00;&#x822C;&#x662F;30s-2min&#x4E0D;&#x7B49;&#xFF0C;&#x5E76;&#x4E14;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E0D;&#x53EF;&#x4FEE;&#x6539;&#x7684;(linux&#x5C06;&#x8FD9;&#x4E00;&#x65F6;&#x95F4;&#x503C;&#x5199;&#x6B7B;&#x5728;&#x4E86;&#x5185;&#x6838;&#x4E2D;)&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x7B49;&#x5F85;2*MSL&#x5462;&#xFF1F;&#x5728;stackoverflow&#x4E2D;&#x627E;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x8F83;&#x4E3A;&#x6613;&#x61C2;&#x7684;&#x89E3;&#x91CA;&#xFF1A;</p>
<p><strong>So the TIME_WAIT time is generally set to double the packets maximum age. This value is the maximum age your packets will be allowed to get to before the network discards them.
That guarantees that, before you&apos;re allowed to create a connection with the same tuple, all the packets belonging to previous incarnations of that tuple will be dead.</strong></p>
<p><strong>&#x7FFB;&#x8BD1;&#x4E00;&#x4E0B;&#xFF1A;</strong>
time_wait&#x65F6;&#x95F4;&#x8BBE;&#x8BA1;&#x4E3A;tcp&#x5206;&#x7247;&#x7684;&#x6700;&#x5927;&#x5B58;&#x6D3B;&#x65F6;&#x95F4;&#x7684;&#x4E24;&#x500D;&#xFF0C;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;&#x7684;&#x539F;&#x56E0;&#x662F;&#xFF0C;&#x7F51;&#x7EDC;&#x662F;&#x5B58;&#x5728;&#x5EF6;&#x8FDF;&#x7684;&#xFF0C;&#x540C;&#x65F6;tcp&#x5206;&#x7247;&#x5728;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;&#x4E2D;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x610F;&#x5916;&#xFF0C;&#x53D1;&#x9001;&#x7AEF;&#x5728;&#x786E;&#x8BA4;&#x610F;&#x5916;(&#x4F8B;&#x5982;&#x5230;&#x8FBE;MSL&#x65F6;&#x95F4;&#x540E;)&#x540E;&#x53D1;&#x51FA;&#x6570;&#x636E;&#x5206;&#x7247;&#x7684;&#x91CD;&#x4F20;&#x3002;&#x5047;&#x5982;socket&#x8FDE;&#x63A5;&#x4E0D;&#x7ECF;&#x7B49;&#x5F85;&#x76F4;&#x63A5;&#x5173;&#x95ED;&#x4E86;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x91CD;&#x65B0;&#x6253;&#x5F00;&#x4E86;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x53F7;&#x4E00;&#x81F4;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x65B0;&#x542F;&#x52A8;&#x7684;socket&#x8FDE;&#x63A5;&#xFF0C;&#x63A5;&#x6536;&#x5230;&#x4E86;&#x6B64;&#x524D;&#x9500;&#x6BC1;&#x5173;&#x95ED;&#x7684;socket&#x8FDE;&#x63A5;&#x7684;&#x6570;&#x636E;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x8BBE;&#x8BA1;TIME_WAIT&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x4E3A;2<em>MSL&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x5728;&#x7B49;&#x5F85;2</em>MSL&#x4E4B;&#x540E;&#xFF0C;&#x6B64;&#x524D;&#x65E7;socket&#x7684;&#x6570;&#x636E;&#x5206;&#x7247;&#x5373;&#x4F7F;&#x8FD8;&#x6CA1;&#x6709;&#x5230;&#x8FBE;&#x63A5;&#x6536;&#x7AEF;&#xFF0C;&#x4E5F;&#x5DF2;&#x7ECF;&#x5728;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;&#x4E2D;&#x8FC7;&#x671F;&#x6D88;&#x901D;&#x4E86;&#xFF0C;&#x65B0;&#x542F;&#x52A8;&#x7684;socket&#x4E0D;&#x4F1A;&#x63A5;&#x6536;&#x5230;&#x6B64;&#x524D;&#x7684;&#x65E7;&#x6570;&#x636E;&#x5206;&#x7247;&#x3002;</p>
<h5 id="&#x4F18;&#x5316;&#x65B9;&#x5F0F;"><a name="&#x4F18;&#x5316;&#x65B9;&#x5F0F;" class="plugin-anchor" href="#&#x4F18;&#x5316;&#x65B9;&#x5F0F;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F18;&#x5316;&#x65B9;&#x5F0F;</h5>
<p>&#x4F18;&#x5316;&#x7684;&#x601D;&#x8DEF;
1.&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x65F6;&#x52A0;&#x901F;&#x8FDB;&#x5165;TIME_WAIT&#x72B6;&#x6001;&#xFF0C;&#x4EE5;&#x5FEB;&#x901F;&#x63D0;&#x4F9B;&#x53EF;&#x7528;&#x7684;&#x8FDE;&#x63A5;&#x7AEF;&#x53E3;
2.&#x89E3;&#x51B3;timestamps&#x4E22;&#x5305;&#x95EE;&#x9898;</p>
<p>&#x67E5;&#x770B;ipvs&#x8BBE;&#x7F6E;&#x7684;&#x5404;&#x7C7B;&#x8FDE;&#x63A5;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF0C;&#x4FEE;&#x6539;&#x9ED8;&#x8BA4;&#x7684;tcpfin 2&#x5206;&#x949F;&#x4E3A;30&#x79D2;</p>
<pre><code>[root@p020107 ~]# ipvsadm -L --timeout 
Timeout (tcp tcpfin udp): 900 120 300
[root@p020107 ~]# ipvsadm --set 900 30 300

[root@p020107 ~]# ipvsadm -L --timeout 
Timeout (tcp tcpfin udp): 900 30 300
</code></pre><p><strong>&#x5185;&#x6838;&#x53C2;&#x6570;&#x4F18;&#x5316;</strong></p>
<p>&#x6DFB;&#x52A0;&#x5165;/etc/sysctl.conf&#x6587;&#x4EF6;&#x4E2D;</p>
<pre><code># &#x8868;&#x793A;&#x5F00;&#x542F;&#x91CD;&#x7528;&#x3002;&#x5141;&#x8BB8;&#x5C06;TIME-WAIT sockets&#x91CD;&#x65B0;&#x7528;&#x4E8E;&#x65B0;&#x7684;TCP&#x8FDE;&#x63A5;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;0&#xFF0C;&#x8868;&#x793A;&#x5173;&#x95ED;&#xFF1B;
  net.ipv4.tcp_tw_reuse = 1

  # &#x8868;&#x793A;&#x5F00;&#x542F;TCP&#x8FDE;&#x63A5;&#x4E2D;TIME-WAIT sockets&#x7684;&#x5FEB;&#x901F;&#x56DE;&#x6536;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;0&#xFF0C;&#x8868;&#x793A;&#x5173;&#x95ED;&#x3002;&#x6CE8;&#x610F;&#xFF0C;net.ipv4.tcp_timestamps&#x9ED8;&#x8BA4;&#x4E3A;&#x5F00;&#x542F;&#xFF0C;tcp_tw_recycle&#x6B64;&#x9009;&#x9879;&#x4E5F;&#x5F00;&#x542F;&#x540E;&#xFF0C;tcp timestamp&#x673A;&#x5236;&#x5C31;&#x4F1A;&#x6FC0;&#x6D3B;&#xFF0C;&#x5728;&#x90E8;&#x5206;&#x573A;&#x666F;&#x4E0B;&#xFF0C;&#x9700;&#x8981;&#x5173;&#x95ED;tcp_timestamps&#x529F;&#x80FD;&#xFF0C;&#x89C1;&#x4E0B;&#x65B9;&#x6B64;&#x9009;&#x9879;&#x7684;&#x8BF4;&#x660E;&#x3002;
  net.ipv4.tcp_tw_recycle = 1

  # &#x4FEE;&#x6539;tcp&#x4F1A;&#x8BDD;&#x8FDB;&#x53BB;fin&#x72B6;&#x6001;&#x540E;&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#xFF0C;&#x8D85;&#x65F6;&#x5219;&#x5173;&#x95ED;&#x4F1A;&#x8BDD;
  net.ipv4.tcp_fin_timeout = 30

  # &#x5904;&#x4E8E;TIME_WAIT&#x6700;&#x5927;&#x7684;socket&#x6570;&#x91CF;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;180 000&#xFF0C;&#x8D85;&#x8FC7;&#x8FD9;&#x4E2A;&#x6570;&#x76EE;&#x7684;socket&#x7ACB;&#x5373;&#x88AB;&#x6E05;&#x9664;
  net.ipv4.tcp_max_tw_buckets=180000

  # tcp&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#x6233;,RFC1323&#x4E2D;&#x63CF;&#x8FF0;&#x4E86;&#xFF0C;&#x7CFB;&#x7EDF;&#x7F13;&#x5B58;&#x6BCF;&#x4E2A;ip&#x6700;&#x65B0;&#x7684;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x540E;&#x7EED;&#x8BF7;&#x6C42;&#x4E2D;&#x8BE5;ip&#x7684;tcp&#x5305;&#x4E2D;&#x7684;&#x65F6;&#x95F4;&#x6233;&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x95F4;&#x6233;(&#x5373;&#x975E;&#x6700;&#x65B0;&#x7684;&#x6570;&#x636E;&#x5305;
)&#xFF0C;&#x5373;&#x89C6;&#x4E3A;&#x65E0;&#x6548;&#xFF0C;&#x76F8;&#x5E94;&#x7684;&#x6570;&#x636E;&#x5305;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x65E0;&#x58F0;&#x7684;&#x4E22;&#x5F03;&#x3002;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6B64;&#x673A;&#x5236;&#x4E0D;&#x4F1A;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x5728;nat&#x6A21;&#x5F0F;&#x65F6;,&#x4E0D;&#x540C;&#x7684;ip&#x88AB;&#x8F6C;&#x6362;&#x6210;&#x540C;&#x4E00;&#x4E2A;ip&#x518D;&#x53BB;&#x8BF7;
&#x6C42;&#x771F;&#x6B63;&#x7684;server&#x7AEF;&#xFF0C;&#x5728;server&#x7AEF;&#x770B;&#x6765;&#xFF0C;&#x6E90;ip&#x90FD;&#x662F;&#x76F8;&#x540C;&#x7684;&#xFF0C;&#x4E14;&#x6B64;&#x65F6;&#x5305;&#x7684;&#x65F6;&#x95F4;&#x6233;&#x987A;&#x5E8F;&#x53EF;&#x80FD;&#x4E0D;&#x4E00;&#x5B9A;&#x4FDD;&#x6301;&#x9012;&#x589E;&#xFF0C;&#x7531;&#x6B64;&#x4F1A;&#x51FA;&#x73B0;&#x4E22;&#x5305;&#x7684;&#x73B0;&#x8C61;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x662F;nat&#x6A21;&#x5F0F;&#x5DE5;&#x4F5C;&#xFF0C;&#x5EFA;&#x8BAE;&#x5173;&#x95ED;&#x6B64;&#x9009;&#x9879;&#x3002;
  net.ipv4.tcp_timestamps = 0
</code></pre><p>&#x8FD9;&#x51E0;&#x4E2A;&#x53C2;&#x6570;&#x4E4B;&#x95F4;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x5173;&#x8054;&#x5173;&#x7CFB;&#xFF0C;&#x53C2;&#x8003;&#x6B64;&#x7BC7;&#x6587;&#x7AE0;,&#x5199;&#x5F97;&#x975E;&#x5E38;&#x8BE6;&#x7EC6;:
<a href="http://www.freeoa.net/osuport/cluster/lvs-inuse-problem-sets_3111.html" target="_blank">http://www.freeoa.net/osuport/cluster/lvs-inuse-problem-sets_3111.html</a></p>
<h2 id="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E09;"><a name="&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E09;" class="plugin-anchor" href="#&#x95EE;&#x9898;&#x9636;&#x6BB5;&#x4E09;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x95EE;&#x9898;&#x9636;&#x6BB5;(&#x4E09;):</h2>
<h5 id="&#x73B0;&#x8C61;"><a name="&#x73B0;&#x8C61;" class="plugin-anchor" href="#&#x73B0;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x73B0;&#x8C61;</h5>
<p>&#x5B8C;&#x6210;&#x4E0A;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;TIME_WAIT&#x6570;&#x91CF;&#x4E0B;&#x964D;&#x5230;&#x4E86;4&#x4F4D;&#x6570;&#xFF0C;&#x4E22;&#x5305;&#x6570;&#x91CF;&#x6CA1;&#x6709;&#x518D;&#x589E;&#x52A0;&#x3002;&#x4F46;&#x662F;&#x8FC7;&#x4E86;&#x4E00;&#x4E9B;&#x5929;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x4E00;&#x6B21;&#x51FA;&#x73B0;&#x4E86;&#x5076;&#x5C14;&#x4E2A;&#x522B;VIP&#x65E0;&#x6CD5;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x6311;&#x9009;&#x4E86;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;VIP 10.111.99.131&#x5F00;&#x59CB;&#x6392;&#x67E5;
client: 192.168.58.36
DIP: 10.111.99.131
RIP: 172.26.8.17</p>
<h5 id="&#x5F00;&#x59CB;&#x6392;&#x67E5;"><a name="&#x5F00;&#x59CB;&#x6392;&#x67E5;" class="plugin-anchor" href="#&#x5F00;&#x59CB;&#x6392;&#x67E5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5F00;&#x59CB;&#x6392;&#x67E5;</h5>
<p>&#x4E09;&#x5C42;&#x8FDE;&#x63A5;&#x6CA1;&#x6709;&#x95EE;&#x9898;:</p>
<pre><code>ywq@ywq:~$ traceroute 10.111.99.131
traceroute to 10.111.99.131 (10.111.99.131), 30 hops max, 60 byte packets
 1  192.168.58.254 (192.168.58.254)  7.952 ms  8.510 ms  9.131 ms
 2  10.111.99.131 (10.111.99.131)  0.253 ms  0.243 ms  0.226 ms

ywq@ywq:~$ ping 10.111.99.131
PING 10.111.99.131 (10.111.99.131) 56(84) bytes of data.
64 bytes from 10.111.99.131: icmp_seq=1 ttl=63 time=0.296 ms
64 bytes from 10.111.99.131: icmp_seq=2 ttl=63 time=0.318 ms
^C
--- 10.111.99.131 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1020ms
rtt min/avg/max/mdev = 0.296/0.307/0.318/0.011 ms
</code></pre><p>tcp&#x8FDE;&#x63A5;&#x65E0;&#x6CD5;&#x5EFA;&#x7ACB;</p>
<pre><code>ywq@ywq:~$ telnet 10.111.99.131 80
Trying 10.111.99.131...
telnet: Unable to connect to remote host: Connection timeout
</code></pre><p>&#x5728;lvs diretor server&#x4E0A;&#x67E5;&#x770B;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#xFF1A;</p>
<pre><code class="lang-bash">[root@p020107 ~]<span class="hljs-comment"># ipvsadm -lnc | grep 58.36</span>
TCP 00:59  TIME_WAIT   192.168.9.13:58236 10.97.85.43:80     172.26.5.209:80
TCP 00:48  SYN_RECV    192.168.58.36:57964 10.111.99.131:80   172.26.8.17:80
TCP 00:48  SYN_RECV    192.168.58.36:57963 10.111.99.131:80   172.26.8.17:80
TCP 00:48  SYN_RECV    192.168.58.36:57965 10.111.99.131:80   172.26.8.17:80
</code></pre>
<p>&#x53D1;&#x73B0;tcp&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x4E3A;SYN_RECV&#x72B6;&#x6001;&#xFF0C;&#x90A3;&#x4E48;&#x6839;&#x636E;&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x534F;&#x5B9A;&#xFF0C;&#x518D;&#x7ED3;&#x5408;lvs&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#xFF0C;&#x8BF4;&#x660E;LVS server&#x63A5;&#x6536;&#x5230;&#x4E86;clien&#x7684;syn&#x5305;,&#x5411;client&#x56DE;&#x590D;&#x4E86;syn+ack&#x7136;&#x540E;&#x8FDB;&#x5165;&#x4E86;SYN_RECV&#x72B6;&#x6001;&#xFF0C;&#x540C;&#x65F6;direct server&#x4F1A;&#x5411;&#x540E;&#x7AEF;&#x7684;real server&#x53D1;&#x8D77;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x7684;&#x8BF7;&#x6C42;&#x3002;&#x65E2;&#x7136;&#x73B0;&#x5728;direct server&#x80FD;&#x4E0E;client&#x7AEF;&#x4EA4;&#x4E92;&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x524D;&#x7684;&#x95EE;&#x9898;&#x5E94;&#x8BE5;&#x5728;&#x4E8E;&#xFF1A;
<strong>direct Server&#x548C;real Server&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x6B63;&#x5E38;&#x5730;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5305;&#x4EA4;&#x4E92;&#x6216;&#x8005;&#x51FA;&#x73B0;&#x4E86;&#x4E22;&#x5305;&#xFF0C;&#x67E5;&#x9605;&#x4E86;&#x5F88;&#x591A;&#x8D44;&#x6599;&#xFF0C;rp_filter&#x8FD9;&#x4E00;&#x5185;&#x6838;&#x53C2;&#x6570;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#x3002;</strong></p>
<p>&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5B98;&#x65B9;&#x5173;&#x4E8E;&#x8FD9;&#x4E00;&#x53C2;&#x6570;&#x7684;&#x89E3;&#x91CA;:</p>
<pre><code>rp_filter - INTEGER
    0 - No source validation.
    1 - Strict mode as defined in RFC3704 Strict Reverse Path
        Each incoming packet is tested against the FIB and if the interface
        is not the best reverse path the packet check will fail.
        By default failed packets are discarded.
    2 - Loose mode as defined in RFC3704 Loose Reverse Path
        Each incoming packet&apos;s source address is also tested against the FIB
        and if the source address is not reachable via any interface
        the packet check will fail.

    Current recommended practice in RFC3704 is to enable strict mode
    to prevent IP spoofing from DDos attacks. If using asymmetric routing
    or other complicated routing, then loose mode is recommended.

    The max value from conf/{all,interface}/rp_filter is used
    when doing source validation on the {interface}.

    Default value is 0. Note that some distributions enable it
    in startup scripts.
</code></pre><p><strong>&#x7B80;&#x5355;&#x89E3;&#x91CA;&#x4E00;&#x4E0B;:</strong>
0:&#x8868;&#x793A;&#x4E0D;&#x5F00;&#x542F;&#x6E90;&#x68C0;&#x6D4B;
1:&#x4E25;&#x683C;&#x6A21;&#x5F0F;&#xFF0C;&#x6839;&#x636E;&#x6570;&#x636E;&#x5305;&#x7684;&#x6E90;&#xFF0C;&#x901A;&#x8FC7;&#x67E5;FIB&#x8868;(Forward Information Table,&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x8DEF;&#x7531;&#x8868;)&#xFF0C;&#x68C0;&#x67E5;&#x6570;&#x636E;&#x5305;&#x8FDB;&#x5165;&#x7AEF;&#x53E3;&#x662F;&#x540C;&#x65F6;&#x4E5F;&#x662F;&#x51FA;&#x7AEF;&#x53E3;&#xFF0C;&#x4EE5;&#x89C6;&#x4E3A;&#x6700;&#x4F73;&#x8DEF;&#x5F84;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x7B26;&#x5408;&#x6700;&#x4F73;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x4E22;&#x5F03;&#x6570;&#x636E;&#x5305;
2:&#x677E;&#x6563;&#x6A21;&#x5F0F;,&#x68C0;&#x67E5;&#x6570;&#x636E;&#x5305;&#x7684;&#x6765;&#x6E90;&#xFF0C;&#x67E5;FIB&#x8868;&#xFF0C;&#x5982;&#x679C;&#x901A;&#x8FC7;&#x4EFB;&#x610F;&#x7AEF;&#x53E3;&#x90FD;&#x65E0;&#x6CD5;&#x5230;&#x8FBE;&#x6B64;&#x6E90;&#xFF0C;&#x5219;&#x4E22;&#x5305;</p>
<p><strong>&#x7ED3;&#x5408;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x6765;&#x8BF4;:</strong>
&#x5728;LVS (nat)+k8s&#x7684;&#x5DE5;&#x4F5C;&#x573A;&#x666F;&#x4E0B;&#xFF0C;LVS Server&#x9001;&#x5F80;Real Server&#x7684;&#x5305;&#x53EF;&#x80FD;&#x8D70;&#x7684;tunnel&#x63A5;&#x53E3;&#xFF0C;&#x800C;Real Server&#x901A;&#x8FC7;tunnel&#x63A5;&#x53E3;&#x6536;&#x5230;&#x5305;&#x540E;&#xFF0C;&#x67E5;&#x8DEF;&#x7531;&#x8868;&#x53D1;&#x73B0;&#x56DE;&#x5305;&#x8981;&#x8D70;&#x7269;&#x7406;eth/bond&#x4E4B;&#x7C7B;&#x63A5;&#x53E3;&#xFF0C;&#x5982;&#x679C;rp_filter&#x5F00;&#x542F;&#x4E86;&#x4E25;&#x683C;&#x6A21;&#x5F0F;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x7F51;&#x7EDC;&#x5F02;&#x5E38;&#x72B6;&#x51B5;</p>
<h5 id="&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x53F0;kube-node&#x7684;&#x7F51;&#x5361;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x53D1;&#x73B0;centos74&#x7684;&#x51E0;&#x53F0;node&#x9ED8;&#x8BA4;&#x786E;&#x5B9E;&#x5F00;&#x542F;&#x4E86;rpfilter&#xFF0C;ubuntu&#x5927;&#x90E8;&#x5206;&#x5219;&#x6CA1;&#x6709;"><a name="&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x53F0;kube-node&#x7684;&#x7F51;&#x5361;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x53D1;&#x73B0;centos74&#x7684;&#x51E0;&#x53F0;node&#x9ED8;&#x8BA4;&#x786E;&#x5B9E;&#x5F00;&#x542F;&#x4E86;rpfilter&#xFF0C;ubuntu&#x5927;&#x90E8;&#x5206;&#x5219;&#x6CA1;&#x6709;" class="plugin-anchor" href="#&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x53F0;kube-node&#x7684;&#x7F51;&#x5361;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x53D1;&#x73B0;centos74&#x7684;&#x51E0;&#x53F0;node&#x9ED8;&#x8BA4;&#x786E;&#x5B9E;&#x5F00;&#x542F;&#x4E86;rpfilter&#xFF0C;ubuntu&#x5927;&#x90E8;&#x5206;&#x5219;&#x6CA1;&#x6709;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x53F0;kube node&#x7684;&#x7F51;&#x5361;&#x914D;&#x7F6E;&#x53C2;&#x6570;,&#x53D1;&#x73B0;centos7.4&#x7684;&#x51E0;&#x53F0;node&#x9ED8;&#x8BA4;&#x786E;&#x5B9E;&#x5F00;&#x542F;&#x4E86;rp_filter&#xFF0C;ubuntu&#x5927;&#x90E8;&#x5206;&#x5219;&#x6CA1;&#x6709;:</h5>
<pre><code># &#x5BB9;&#x5668;&#x5185;&#x7684;veth&#x7F51;&#x5361;&#x53EF;&#x5FFD;&#x7565;&#xFF0C;&#x56E0;&#x4E3A;&#x5BB9;&#x5668;&#x672C;&#x8EAB;&#x53EA;&#x6709;&#x4E00;&#x5757;&#x5BF9;&#x5916;&#x7684;&#x7F51;&#x5361;
[root@p020114 ~]# sysctl -a | grep rp_filter | grep -v &apos;veth&apos;
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.bond0.rp_filter = 1
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.docker0.rp_filter = 2
net.ipv4.conf.dummy0.rp_filter = 0
net.ipv4.conf.em1.rp_filter = 1
net.ipv4.conf.em2.rp_filter = 1
net.ipv4.conf.em3.rp_filter = 1
net.ipv4.conf.em4.rp_filter = 1
net.ipv4.conf.kube-bridge.rp_filter = 0
net.ipv4.conf.kube-dummy-if.rp_filter = 0
net.ipv4.conf.lo.rp_filter = 0
net.ipv4.conf.tun-192168926.rp_filter = 1
net.ipv4.conf.tun-192168927.rp_filter = 1
net.ipv4.conf.tun-192168928.rp_filter = 1
net.ipv4.conf.tun-192168929.rp_filter = 1
net.ipv4.conf.tunl0.rp_filter = 0
</code></pre><p>&#x5173;&#x95ED;&#x6B64;&#x529F;&#x80FD;</p>
<pre><code>echo &quot;
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.bond0.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.docker0.rp_filter = 2
net.ipv4.conf.dummy0.rp_filter = 0
net.ipv4.conf.em1.rp_filter = 0
net.ipv4.conf.em2.rp_filter = 0
net.ipv4.conf.em3.rp_filter = 0
net.ipv4.conf.em4.rp_filter = 0
net.ipv4.conf.kube-bridge.rp_filter = 0
net.ipv4.conf.kube-dummy-if.rp_filter = 0
net.ipv4.conf.lo.rp_filter = 0
net.ipv4.conf.tun-192168926.rp_filter = 0
net.ipv4.conf.tun-192168927.rp_filter = 0
net.ipv4.conf.tun-192168928.rp_filter = 0
net.ipv4.conf.tun-192168929.rp_filter = 0
net.ipv4.conf.tunl0.rp_filter = 0
&quot; &gt;&gt; /etc/sysctl.conf
</code></pre><p>&#x52A0;&#x8F7D;&#x751F;&#x6548;</p>
<pre><code>sysctl -p
</code></pre><h2 id="&#x603B;&#x7ED3;"><a name="&#x603B;&#x7ED3;" class="plugin-anchor" href="#&#x603B;&#x7ED3;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x603B;&#x7ED3;</h2>
<p>VIP&#x5076;&#x5C14;&#x65E0;&#x6CD5;&#x5EFA;&#x7ACB;TCP&#x8FDE;&#x63A5;&#x7684;&#x95EE;&#x9898;&#x5DF2;&#x89E3;&#x51B3;&#xFF0C;&#x4E00;&#x4E2A;&#x661F;&#x671F;&#x8FC7;&#x53BB;&#x4E86;&#x6CA1;&#x6709;&#x518D;&#x590D;&#x73B0;&#xFF0C;&#x7EE7;&#x7EED;&#x89C2;&#x5BDF;ing.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Kubernetes部署问题记录.html" class="navigation navigation-prev " aria-label="Previous page: 8.1. 集群部署问题记录">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="kubeadm证书-etcd证书过期紧急处理.html" class="navigation navigation-next " aria-label="Next page: 8.3. kubeadm证书-etcd证书过期紧急处理">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"8.2. Service ipvs模式间断性TCP连接故障排查","date":"2018/12/11 11:49:16","tags":["Kubernetes","Network"],"level":"8.1.2","depth":2,"next":{"title":"8.3. kubeadm证书-etcd证书过期紧急处理","level":"8.1.3","depth":2,"path":"part8/kubeadm证书-etcd证书过期紧急处理.md","ref":"./part8/kubeadm证书-etcd证书过期紧急处理.md","articles":[]},"previous":{"title":"8.1. 集群部署问题记录","level":"8.1.1","depth":2,"path":"part8/Kubernetes部署问题记录.md","ref":"./part8/Kubernetes部署问题记录.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","anchors","github","expandable-chapters","splitter","back-to-top-button"],"styles":{"website":"./styles/website.css"},"pluginsConfig":{"github":{"url":"https://github.com/yinwenqin/kubeSourceCodeNote"},"splitter":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"back-to-top-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"expandable-chapters":{}},"theme":"default","author":"ywq","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Kubernetes生态圈使用","language":"zh-hans","links":{},"gitbook":"3.2.3","description":""},"file":{"path":"part8/Service-ipvs模式间断性TCP连接故障排查.md","mtime":"2019-11-21T07:58:03.724Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-12-10T07:49:45.760Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

